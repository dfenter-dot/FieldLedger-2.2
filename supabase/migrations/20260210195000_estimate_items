-- Estimate Items RLS Policies
--
-- Fix: estimate line items not saving because DELETE/INSERT/UPDATE are blocked by RLS.
--
-- Assumptions:
--   - public.profiles has columns: user_id (uuid), company_id (uuid)
--   - public.estimates has column: company_id (uuid)
--   - public.estimate_options has column: estimate_id (uuid)
--   - public.estimate_items has column: estimate_option_id (uuid)

alter table if exists public.estimate_items enable row level security;

-- Helper predicate: does the current user belong to the same company as the estimate group?
-- NOTE: auth.uid() is the logged-in user id.

create policy if not exists "estimate_items_select_own_company" on public.estimate_items
for select
using (
  exists (
    select 1
    from public.estimate_options eo
    join public.estimates e on e.id = eo.estimate_id
    join public.profiles p on p.company_id = e.company_id
    where eo.id = estimate_items.estimate_option_id
      and p.user_id = auth.uid()
  )
);

create policy if not exists "estimate_items_insert_own_company" on public.estimate_items
for insert
with check (
  exists (
    select 1
    from public.estimate_options eo
    join public.estimates e on e.id = eo.estimate_id
    join public.profiles p on p.company_id = e.company_id
    where eo.id = estimate_items.estimate_option_id
      and p.user_id = auth.uid()
  )
);

create policy if not exists "estimate_items_update_own_company" on public.estimate_items
for update
using (
  exists (
    select 1
    from public.estimate_options eo
    join public.estimates e on e.id = eo.estimate_id
    join public.profiles p on p.company_id = e.company_id
    where eo.id = estimate_items.estimate_option_id
      and p.user_id = auth.uid()
  )
)
with check (
  exists (
    select 1
    from public.estimate_options eo
    join public.estimates e on e.id = eo.estimate_id
    join public.profiles p on p.company_id = e.company_id
    where eo.id = estimate_items.estimate_option_id
      and p.user_id = auth.uid()
  )
);

create policy if not exists "estimate_items_delete_own_company" on public.estimate_items
for delete
using (
  exists (
    select 1
    from public.estimate_options eo
    join public.estimates e on e.id = eo.estimate_id
    join public.profiles p on p.company_id = e.company_id
    where eo.id = estimate_items.estimate_option_id
      and p.user_id = auth.uid()
  )
);

