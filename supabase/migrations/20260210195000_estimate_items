BEGIN;

ALTER TABLE public.estimate_items ENABLE ROW LEVEL SECURITY;

DO $$
DECLARE
  fk_col text;
BEGIN
  -- Detect which column links estimate_items -> estimate_options
  SELECT c.column_name
  INTO fk_col
  FROM information_schema.columns c
  WHERE c.table_schema = 'public'
    AND c.table_name = 'estimate_items'
    AND c.column_name IN ('estimate_option_id', 'option_id', 'estimate_options_id', 'estimate_option_uuid')
  ORDER BY CASE c.column_name
    WHEN 'estimate_option_id' THEN 1
    WHEN 'option_id' THEN 2
    WHEN 'estimate_options_id' THEN 3
    WHEN 'estimate_option_uuid' THEN 4
    ELSE 99
  END
  LIMIT 1;

  IF fk_col IS NULL THEN
    RAISE EXCEPTION 'Could not find option FK column on public.estimate_items. Expected one of: estimate_option_id, option_id, estimate_options_id, estimate_option_uuid';
  END IF;

  -- Drop policies if they already exist (safe re-run)
  IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname='public' AND tablename='estimate_items' AND policyname='estimate_items_select_own_company') THEN
    EXECUTE 'DROP POLICY estimate_items_select_own_company ON public.estimate_items';
  END IF;
  IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname='public' AND tablename='estimate_items' AND policyname='estimate_items_insert_own_company') THEN
    EXECUTE 'DROP POLICY estimate_items_insert_own_company ON public.estimate_items';
  END IF;
  IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname='public' AND tablename='estimate_items' AND policyname='estimate_items_update_own_company') THEN
    EXECUTE 'DROP POLICY estimate_items_update_own_company ON public.estimate_items';
  END IF;
  IF EXISTS (SELECT 1 FROM pg_policies WHERE schemaname='public' AND tablename='estimate_items' AND policyname='estimate_items_delete_own_company') THEN
    EXECUTE 'DROP POLICY estimate_items_delete_own_company ON public.estimate_items';
  END IF;

  -- Create policies using the detected FK column to estimate_options
  EXECUTE format($sql$
    CREATE POLICY estimate_items_select_own_company
    ON public.estimate_items
    FOR SELECT
    USING (
      EXISTS (
        SELECT 1
        FROM public.estimate_options eo
        JOIN public.estimates e ON e.id = eo.estimate_id
        JOIN public.profiles p ON p.company_id = e.company_id
        WHERE eo.id = estimate_items.%I
          AND p.user_id = auth.uid()
      )
    );
  $sql$, fk_col);

  EXECUTE format($sql$
    CREATE POLICY estimate_items_insert_own_company
    ON public.estimate_items
    FOR INSERT
    WITH CHECK (
      EXISTS (
        SELECT 1
        FROM public.estimate_options eo
        JOIN public.estimates e ON e.id = eo.estimate_id
        JOIN public.profiles p ON p.company_id = e.company_id
        WHERE eo.id = estimate_items.%I
          AND p.user_id = auth.uid()
      )
    );
  $sql$, fk_col);

  EXECUTE format($sql$
    CREATE POLICY estimate_items_update_own_company
    ON public.estimate_items
    FOR UPDATE
    USING (
      EXISTS (
        SELECT 1
        FROM public.estimate_options eo
        JOIN public.estimates e ON e.id = eo.estimate_id
        JOIN public.profiles p ON p.company_id = e.company_id
        WHERE eo.id = estimate_items.%I
          AND p.user_id = auth.uid()
      )
    )
    WITH CHECK (
      EXISTS (
        SELECT 1
        FROM public.estimate_options eo
        JOIN public.estimates e ON e.id = eo.estimate_id
        JOIN public.profiles p ON p.company_id = e.company_id
        WHERE eo.id = estimate_items.%I
          AND p.user_id = auth.uid()
      )
    );
  $sql$, fk_col, fk_col);

  EXECUTE format($sql$
    CREATE POLICY estimate_items_delete_own_company
    ON public.estimate_items
    FOR DELETE
    USING (
      EXISTS (
        SELECT 1
        FROM public.estimate_options eo
        JOIN public.estimates e ON e.id = eo.estimate_id
        JOIN public.profiles p ON p.company_id = e.company_id
        WHERE eo.id = estimate_items.%I
          AND p.user_id = auth.uid()
      )
    );
  $sql$, fk_col);

END $$;

COMMIT;
